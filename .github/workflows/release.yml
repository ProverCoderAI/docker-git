name: Release
on:
  workflow_run:
    workflows: ["Check"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  actions: write
  id-token: write
  pull-requests: write
  packages: write

jobs:
  release:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Detect npm publish eligibility
        id: npm_gate
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          echo "publish_npm=false" >> "$GITHUB_OUTPUT"

          PKG_PATH="packages/app/package.json"
          PKG_NAME="$(node -p "require('./${PKG_PATH}').name")"
          PKG_SCOPE="$(printf "%s" "$PKG_NAME" | sed -n 's#^@\([^/]*\)/.*#\1#p')"

          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "::notice::NPM_TOKEN is empty; npm publish disabled for this run."
            exit 0
          fi

          printf '%s\n' "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > "$HOME/.npmrc"

          if ! npm whoami >/dev/null 2>&1; then
            echo "::warning::NPM_TOKEN is invalid/revoked; npm publish disabled for this run."
            exit 0
          fi

          if [ -n "$PKG_SCOPE" ]; then
            if ! npm access ls-packages "$PKG_SCOPE" >/dev/null 2>&1; then
              echo "::warning::No publish access to npm scope '$PKG_SCOPE'; npm publish disabled for this run."
              exit 0
            fi
          fi

          echo "publish_npm=true" >> "$GITHUB_OUTPUT"
          echo "::notice::npm publish is enabled for package ${PKG_NAME}."

      - uses: ProverCoderAI/action-release@v1.0.17
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          npm_token: ${{ secrets.NPM_TOKEN }}
          ref: ${{ github.event.workflow_run.head_sha }}
          branch: ${{ github.event.workflow_run.head_branch }}
          package_json_path: packages/app/package.json
          pnpm_filter: ./packages/app
          bump_type: patch
          publish_npm: ${{ steps.npm_gate.outputs.publish_npm }}
          publish_github_packages: true
          skip_if_unchanged: true
          cancel_on_no_changes: true
