#!/usr/bin/env bash
set -euo pipefail

HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/.." && pwd)"
cd "$REPO_ROOT"

node scripts/split-knowledge-large-files.js
while IFS= read -r -d '' knowledge_dir; do
  git add -A -- "$knowledge_dir"
done < <(
  find . -type d \
    \( -name ".knowledge" -o -name ".knowlenge" \) \
    -not -path "*/.git/*" \
    -print0
)

MAX_BYTES=$((99 * 1000 * 1000))
too_large=()

while IFS= read -r -d '' path; do
  if ! git cat-file -e ":$path" 2>/dev/null; then
    continue
  fi
  size=$(git cat-file -s ":$path")
  if [ "$size" -gt "$MAX_BYTES" ]; then
    too_large+=("$path ($size bytes)")
  fi
done < <(git diff --cached --name-only -z --diff-filter=ACM)

if [ "${#too_large[@]}" -gt 0 ]; then
  echo "ERROR: Staged files exceed 99MB limit (99,000,000 bytes)."
  printf ' - %s\n' "${too_large[@]}"
  exit 1
fi

bash "$REPO_ROOT/scripts/pre-commit-secret-guard.sh"
